# Define a versão do Docker Compose (compatível com Docker Engine 20.10+)
version: '3.8'

# Seção que define todos os serviços/containers que serão executados
services:
  
  # ====================
  # SERVIÇO: BACKEND
  # ====================
  backend:
    # Constrói a imagem a partir do Dockerfile dentro da pasta golden-movie-studio-backend
    build: ./golden-movie-studio-backend
    
    # Nome do container (aparece em 'docker ps')
    container_name: gms-backend
    
    # Mapeia porta do host para porta do container: host:container
    # Permite acessar o backend em http://localhost:3000
    ports:
      - "3000:3000"
    
    # Variáveis de ambiente passadas para dentro do container
    # HOST=0.0.0.0 permite conexões de qualquer origem (importante para Docker)
    # PORT=3000 define a porta que o Node.js vai usar
    environment:
      - PORT=3000
      - HOST=0.0.0.0
    
    # Conecta o container à rede 'gms-network' para comunicação com outros containers
    networks:
      - gms-network

  # ====================
  # SERVIÇO: FRONTEND
  # ====================
  frontend:
    # Constrói a imagem a partir do Dockerfile dentro da pasta golden-movie-studio-frontend
    build: ./golden-movie-studio-frontend
    
    # Nome do container
    container_name: gms-frontend
    
    # Mapeia porta do host para porta do container
    # Permite acessar o frontend em http://localhost:8080
    ports:
      - "8080:8080"
    
    # Variáveis de ambiente
    # PORT=8080 define a porta que o servidor Node.js vai usar
    environment:
      - PORT=8080
    
    # Aguarda o serviço 'backend' estar pronto antes de iniciar
    # Garante que a porta 3000 esteja disponível quando o frontend tentar conectar
    depends_on:
      - backend
    
    # Conecta à mesma rede do backend para comunicação interna
    networks:
      - gms-network

  # ====================
  # SERVIÇO: TESTES (CYPRESS)
  # ====================
  cypress:
    # Constrói a imagem a partir do Dockerfile dentro da pasta tests
    build: ./tests
    
    # Nome do container
    container_name: gms-cypress
    
    # Aguarda ambos os serviços estarem prontos antes de rodar os testes
    # Garante que frontend e backend estão acessíveis
    depends_on:
      - backend
      - frontend
    
    # Conecta à mesma rede para acessar frontend e backend
    networks:
      - gms-network
    
    # Volumes para persistir evidências (screenshots e vídeos)
    volumes:
      # Mapeia a pasta cypress/videos do container para a máquina host
      - ./tests/cypress/videos:/app/cypress/videos
      # Mapeia a pasta cypress/screenshots do container para a máquina host
      - ./tests/cypress/screenshots:/app/cypress/screenshots
    
    # Variáveis de ambiente para o Cypress
    environment:
      # URL base do frontend que o Cypress vai testar
      - CYPRESS_BASE_URL=http://frontend:8080
      # URL da API backend (usado nos testes)
      - CYPRESS_API_URL=http://backend:3000

# ====================
# SEÇÃO: REDES
# ====================
# Define a rede isolada onde os containers se comunicam
networks:
  # Nome da rede que conecta backend e frontend
  gms-network:
    # Driver bridge permite comunicação entre containers na mesma rede
    # Os containers conseguem se encontrar pelos nomes (gms-backend, gms-frontend)
    driver: bridge
